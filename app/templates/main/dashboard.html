{% extends "base.html" %}

{% block hero %}
<!-- Hero Section -->
<div class="hero-section">
    <div class="hero-overlay"></div>
    <div class="hero-content">
        <div class="hero-badge">ğŸ”¥ Keep Going!</div>
        <h1 class="hero-title">Welcome back, {{ current_user.username }}</h1>
        <p class="hero-description">You're making incredible progress! Continue your learning journey with your personalized decks.</p>

        <div class="hero-stats">
            <div class="hero-stat">
                <div class="hero-stat-value">{{ user_stats.total_decks }}</div>
                <div class="hero-stat-label">Active Decks</div>
            </div>
            <div class="hero-stat">
                <div class="hero-stat-value">{{ user_stats.total_cards }}</div>
                <div class="hero-stat-label">Total Cards</div>
            </div>
            <div class="hero-stat">
                <div class="hero-stat-value">
                    {% if deck_stats %}
                        {% set total_accuracy = deck_stats | selectattr('stats.avg_accuracy', 'greaterthan', 0) | map(attribute='stats.avg_accuracy') | list %}
                        {% if total_accuracy %}
                            {{ (total_accuracy | sum / total_accuracy | length) | round | int }}%
                        {% else %}
                            -
                        {% endif %}
                    {% else %}
                        -
                    {% endif %}
                </div>
                <div class="hero-stat-label">Avg Accuracy</div>
            </div>
        </div>

        <div class="hero-buttons">
            <a href="{{ url_for('decks.index') }}" class="btn btn-primary">
                â–¶ï¸ Continue Learning
            </a>
            <a href="{{ url_for('decks.create') }}" class="btn btn-secondary">
                â• Create New Deck
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Continue Learning Section -->
{% if deck_stats %}
<div class="content-section">
    <div class="section-header">
        <h2 class="section-title">ğŸ“– Continue Learning</h2>
        <a href="{{ url_for('decks.index') }}" class="view-all">View all â†’</a>
    </div>

    <div class="carousel-container">
        <div class="scroll-btn scroll-btn-left" onclick="scrollCarousel('continue', -1)">â€¹</div>
        <div class="carousel-wrapper" id="continue-carousel">
            <div class="carousel">
                {% for deck_stat in deck_stats %}
                <div style="min-width: 320px; max-width: 320px; height: 440px; background: var(--color-bg-secondary); border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.3s ease; border: 1px solid var(--color-border-light); display: flex; flex-direction: column;"
                     onclick="window.location.href='{{ url_for('decks.view', id=deck_stat.deck.id) }}'"
                     onmouseover="this.style.transform='scale(1.05) translateY(-8px)'; this.style.borderColor='var(--color-border-primary)'; this.style.boxShadow='var(--shadow-xl)'; this.style.zIndex='10';"
                     onmouseout="this.style.transform='scale(1) translateY(0)'; this.style.borderColor='var(--color-border-light)'; this.style.boxShadow='none'; this.style.zIndex='1';">

                    <!-- Card Image - Fixed Height -->
                    <div style="width: 100%; height: 180px; background: {{ ['linear-gradient(135deg, #667eea 0%, #764ba2 100%)', 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)', 'linear-gradient(135deg, #fccb90 0%, #d57eeb 100%)'][loop.index0 % 5] }}; position: relative; flex-shrink: 0;">
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.3); display: flex; align-items: center; justify-content: center; font-size: 64px; opacity: 0.6;">
                            {% if 'spanish' in deck_stat.deck.name.lower() %}ğŸ“š
                            {% elif 'python' in deck_stat.deck.name.lower() or 'programming' in deck_stat.deck.name.lower() %}ğŸ’»
                            {% elif 'math' in deck_stat.deck.name.lower() %}ğŸ“
                            {% elif 'science' in deck_stat.deck.name.lower() or 'biology' in deck_stat.deck.name.lower() %}ğŸ§¬
                            {% elif 'history' in deck_stat.deck.name.lower() %}ğŸ“œ
                            {% elif 'language' in deck_stat.deck.name.lower() %}ğŸŒ
                            {% else %}ğŸ“•
                            {% endif %}
                        </div>
                        <div style="position: absolute; top: 12px; right: 12px; padding: 6px 12px; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); border-radius: 20px; font-size: 11px; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 0.5px;">
                            {% if deck_stat.deck.is_public %}PUBLIC{% else %}PRIVATE{% endif %}
                        </div>
                    </div>

                    <!-- Card Content - Fixed Height with Scroll -->
                    <div style="padding: 20px; flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                        <h3 style="font-size: 18px; font-weight: 700; margin: 0 0 8px 0; color: var(--color-text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            {{ deck_stat.deck.name }}
                        </h3>

                        <p style="color: var(--color-text-tertiary); margin: 0 0 12px 0; font-size: 14px; line-height: 1.4; height: 40px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                            {% if deck_stat.deck.description %}
                                {{ deck_stat.deck.description }}
                            {% else %}
                                Start studying this deck to build your knowledge
                            {% endif %}
                        </p>

                        <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 13px; color: var(--color-text-muted); flex-shrink: 0;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                ğŸƒ {{ deck_stat.stats.total_cards }} cards
                            </div>
                            {% if deck_stat.stats.avg_accuracy > 0 %}
                            <div style="display: flex; align-items: center; gap: 6px;">
                                ğŸ¯ {{ deck_stat.stats.avg_accuracy }}% accuracy
                            </div>
                            {% endif %}
                        </div>

                        {% if deck_stat.stats.avg_accuracy > 0 %}
                        <div style="margin-bottom: 12px; flex-shrink: 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px;">
                                <span style="color: var(--color-text-tertiary);">Mastery</span>
                                <span style="color: #667eea; font-weight: 700;">{{ deck_stat.stats.avg_accuracy }}%</span>
                            </div>
                            <div style="height: 4px; background: var(--overlay-medium); border-radius: 2px; overflow: hidden;">
                                <div style="height: 100%; width: {{ deck_stat.stats.avg_accuracy }}%; background: var(--gradient-primary); border-radius: 2px; transition: width 0.6s ease;"></div>
                            </div>
                        </div>
                        {% endif %}

                        <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; flex-shrink: 0;">
                            {% if deck_stat.deck.is_public %}
                            <span style="padding: 4px 10px; background: var(--overlay-light); border-radius: 6px; font-size: 11px; color: var(--color-text-tertiary); border: 1px solid var(--color-border-medium);">Public</span>
                            {% endif %}
                            <span style="padding: 4px 10px; background: var(--overlay-light); border-radius: 6px; font-size: 11px; color: var(--color-text-tertiary); border: 1px solid var(--color-border-medium);">{{ deck_stat.stats.total_cards }} Cards</span>
                        </div>

                        <div style="display: flex; gap: 8px; margin-top: auto; flex-shrink: 0;">
                            <a href="{{ url_for('study.start', deck_id=deck_stat.deck.id) }}"
                               style="flex: 1; padding: 10px; background: var(--gradient-primary); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 13px; text-align: center; text-decoration: none; display: block;"
                               onclick="event.stopPropagation();"
                               onmouseover="this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)';"
                               onmouseout="this.style.boxShadow='none';">
                                â–¶ï¸ Study
                            </a>
                            <a href="{{ url_for('decks.view', id=deck_stat.deck.id) }}"
                               style="flex: 1; padding: 10px; background: rgba(102, 126, 234, 0.2); border: 1px solid var(--color-border-primary); border-radius: 6px; color: var(--color-primary-light); font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 13px; text-align: center; text-decoration: none; display: block;"
                               onclick="event.stopPropagation();"
                               onmouseover="this.style.background='rgba(102, 126, 234, 0.3)'; this.style.borderColor='rgba(102, 126, 234, 0.5)';"
                               onmouseout="this.style.background='rgba(102, 126, 234, 0.2)'; this.style.borderColor='var(--color-border-primary)';">
                                ğŸ“Š View
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="scroll-btn scroll-btn-right" onclick="scrollCarousel('continue', 1)">â€º</div>
    </div>
</div>
{% endif %}

<!-- Review Needed Section -->
{% if decks_needing_attention %}
<div class="content-section">
    <div class="section-header">
        <h2 class="section-title">âš ï¸ Review Needed</h2>
        <a href="{{ url_for('decks.index') }}" class="view-all">View all â†’</a>
    </div>

    <div class="carousel-container">
        <div class="scroll-btn scroll-btn-left" onclick="scrollCarousel('review', -1)">â€¹</div>
        <div class="carousel-wrapper" id="review-carousel">
            <div class="carousel">
                <!-- Feature Card - Same Size as Other Cards -->
                <div style="min-width: 320px; max-width: 320px; height: 440px; background: var(--gradient-hero); border-radius: 12px; padding: 24px; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; border: 1px solid var(--color-border-medium); flex-shrink: 0;">
                    <div style="content: ''; position: absolute; top: -50%; right: -50%; width: 300px; height: 300px; background: radial-gradient(circle, rgba(102, 126, 234, 0.2) 0%, transparent 70%);"></div>
                    <div style="position: relative; z-index: 1; flex: 1; display: flex; flex-direction: column;">
                        <div style="display: inline-block; padding: 6px 12px; background: rgba(102, 126, 234, 0.2); border: 1px solid var(--color-border-primary); border-radius: 20px; font-size: 11px; font-weight: 700; color: var(--color-primary-light); margin-bottom: 16px; align-self: flex-start;">
                            â° URGENT
                        </div>
                        <h3 style="font-size: 20px; font-weight: 800; margin-bottom: 12px; line-height: 1.3;">
                            {{ decks_needing_attention|length }} Deck{% if decks_needing_attention|length != 1 %}s{% endif %} Need Your Attention
                        </h3>
                        <p style="font-size: 13px; color: var(--color-text-tertiary); margin-bottom: 20px; line-height: 1.5; flex: 1;">
                            Don't lose your progress! Review these decks to maintain your knowledge.
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 16px; margin-bottom: 20px;">
                            <div>
                                <div style="font-size: 32px; font-weight: 900; margin-bottom: 4px;">
                                    {{ decks_needing_attention | sum(attribute='review_count') }}
                                </div>
                                <div style="font-size: 12px; color: var(--color-text-muted);">Cards Due Review</div>
                            </div>
                            <div>
                                <div style="font-size: 32px; font-weight: 900; margin-bottom: 4px;">
                                    {{ decks_needing_attention|length }}
                                </div>
                                <div style="font-size: 12px; color: var(--color-text-muted);">Decks Waiting</div>
                            </div>
                        </div>
                    </div>
                    <a href="{{ url_for('decks.index') }}"
                       style="position: relative; z-index: 1; display: block; padding: 12px; background: var(--gradient-primary); border: none; border-radius: 8px; color: white; font-weight: 700; text-align: center; text-decoration: none; transition: all 0.3s ease;"
                       onmouseover="this.style.boxShadow='var(--shadow-primary)';"
                       onmouseout="this.style.boxShadow='none';">
                        ğŸ”„ Start Reviewing
                    </a>
                </div>

                <!-- Review Deck Cards - Same Height as Feature Card -->
                {% for deck_attention in decks_needing_attention %}
                <div style="min-width: 320px; max-width: 320px; height: 440px; background: var(--color-bg-secondary); border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.3s ease; border: 1px solid var(--color-border-light); display: flex; flex-direction: column;"
                     onclick="window.location.href='{{ url_for('decks.view', id=deck_attention.deck.id) }}'"
                     onmouseover="this.style.transform='scale(1.05) translateY(-8px)'; this.style.borderColor='var(--color-border-primary)'; this.style.boxShadow='var(--shadow-xl)'; this.style.zIndex='10';"
                     onmouseout="this.style.transform='scale(1) translateY(0)'; this.style.borderColor='var(--color-border-light)'; this.style.boxShadow='none'; this.style.zIndex='1';">

                    <div style="width: 100%; height: 180px; background: {{ ['linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)', 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)'][loop.index0 % 3] }}; position: relative; flex-shrink: 0;">
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.3); display: flex; align-items: center; justify-content: center; font-size: 64px; opacity: 0.6;">
                            {% if 'history' in deck_attention.deck.name.lower() %}ğŸ“œ
                            {% elif 'chemistry' in deck_attention.deck.name.lower() or 'science' in deck_attention.deck.name.lower() %}âš—ï¸
                            {% elif 'math' in deck_attention.deck.name.lower() or 'geometry' in deck_attention.deck.name.lower() %}ğŸ“
                            {% else %}ğŸ“š
                            {% endif %}
                        </div>
                        <div style="position: absolute; top: 12px; right: 12px; padding: 6px 12px; background: rgba(239, 68, 68, 0.9); backdrop-filter: blur(10px); border-radius: 20px; font-size: 11px; font-weight: 700; color: white;">
                            NEEDS REVIEW
                        </div>
                    </div>

                    <div style="padding: 20px; flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                        <h3 style="font-size: 18px; font-weight: 700; margin: 0 0 8px 0; color: var(--color-text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            {{ deck_attention.deck.name }}
                        </h3>

                        <p style="color: var(--color-text-tertiary); margin: 0 0 12px 0; font-size: 14px; line-height: 1.4; height: 40px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                            {% if deck_attention.deck.description %}
                                {{ deck_attention.deck.description }}
                            {% else %}
                                Review these cards to maintain your progress
                            {% endif %}
                        </p>

                        <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 13px; color: var(--color-text-muted); flex-shrink: 0;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                ğŸƒ {{ deck_attention.deck.flashcards|length }} cards
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px; color: #ef4444;">
                                âš ï¸ {{ deck_attention.review_count }} due
                            </div>
                        </div>

                        <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; flex-shrink: 0;">
                            <span style="padding: 4px 10px; background: var(--overlay-light); border-radius: 6px; font-size: 11px; color: var(--color-text-tertiary); border: 1px solid var(--color-border-medium);">Review</span>
                            <span style="padding: 4px 10px; background: var(--overlay-light); border-radius: 6px; font-size: 11px; color: var(--color-text-tertiary); border: 1px solid var(--color-border-medium);">{{ deck_attention.review_count }} Due</span>
                        </div>

                        <div style="display: flex; gap: 8px; margin-top: auto; flex-shrink: 0;">
                            <a href="{{ url_for('study.review', deck_id=deck_attention.deck.id) }}"
                               style="flex: 1; padding: 10px; background: var(--gradient-primary); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 13px; text-align: center; text-decoration: none; display: block;"
                               onclick="event.stopPropagation();">
                                ğŸ”„ Review Now
                            </a>
                            <a href="{{ url_for('decks.view', id=deck_attention.deck.id) }}"
                               style="flex: 1; padding: 10px; background: rgba(102, 126, 234, 0.2); border: 1px solid var(--color-border-primary); border-radius: 6px; color: var(--color-primary-light); font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 13px; text-align: center; text-decoration: none; display: block;"
                               onclick="event.stopPropagation();">
                                ğŸ“Š Stats
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="scroll-btn scroll-btn-right" onclick="scrollCarousel('review', 1)">â€º</div>
    </div>
</div>
{% endif %}

<!-- Empty State -->
{% if not deck_stats and not decks_needing_attention %}
<div class="content-section">
    <div style="text-align: center; padding: 80px 24px;">
        <div style="font-size: 80px; margin-bottom: 24px; opacity: 0.3; animation: float 3s ease-in-out infinite;">ğŸ“š</div>
        <h2 style="font-size: 28px; font-weight: 700; margin: 0 0 12px 0;">No Decks Yet</h2>
        <p style="color: var(--color-text-tertiary); margin: 0 0 32px 0; max-width: 500px; margin-left: auto; margin-right: auto;">
            Create your first flashcard deck to start your learning journey! You can also explore public decks created by others.
        </p>
        <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
            <a href="{{ url_for('decks.create') }}" class="btn btn-primary">
                â• Create Your First Deck
            </a>
            <a href="{{ url_for('decks.public') }}" class="btn btn-secondary">
                ğŸŒ Explore Public Decks
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Quick Stats -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 80px 4% 60px; max-width: 1400px; margin-left: auto; margin-right: auto;">
    <div style="background: var(--color-bg-secondary); border: 1px solid var(--color-border-light); border-radius: 12px; padding: 24px; transition: all 0.3s ease;"
         onmouseover="this.style.borderColor='var(--color-border-primary)'; this.style.transform='translateY(-4px)';"
         onmouseout="this.style.borderColor='var(--color-border-light)'; this.style.transform='translateY(0)';">
        <div style="font-size: 32px; margin-bottom: 12px;">ğŸ“š</div>
        <div style="font-size: 28px; font-weight: 800; margin-bottom: 4px;">{{ user_stats.total_decks }}</div>
        <div style="font-size: 14px; color: var(--color-text-muted);">Total Decks</div>
    </div>
    <div style="background: var(--color-bg-secondary); border: 1px solid var(--color-border-light); border-radius: 12px; padding: 24px; transition: all 0.3s ease;"
         onmouseover="this.style.borderColor='var(--color-border-primary)'; this.style.transform='translateY(-4px)';"
         onmouseout="this.style.borderColor='var(--color-border-light)'; this.style.transform='translateY(0)';">
        <div style="font-size: 32px; margin-bottom: 12px;">ğŸƒ</div>
        <div style="font-size: 28px; font-weight: 800; margin-bottom: 4px;">{{ user_stats.total_cards }}</div>
        <div style="font-size: 14px; color: var(--color-text-muted);">Total Cards</div>
    </div>
    <div style="background: var(--color-bg-secondary); border: 1px solid var(--color-border-light); border-radius: 12px; padding: 24px; transition: all 0.3s ease;"
         onmouseover="this.style.borderColor='var(--color-border-primary)'; this.style.transform='translateY(-4px)';"
         onmouseout="this.style.borderColor='var(--color-border-light)'; this.style.transform='translateY(0)';">
        <div style="font-size: 32px; margin-bottom: 12px;">ğŸ¯</div>
        <div style="font-size: 28px; font-weight: 800; margin-bottom: 4px;">
            {% if deck_stats %}
                {% set total_accuracy = deck_stats | selectattr('stats.avg_accuracy', 'greaterthan', 0) | map(attribute='stats.avg_accuracy') | list %}
                {% if total_accuracy %}
                    {{ (total_accuracy | sum / total_accuracy | length) | round | int }}%
                {% else %}
                    -
                {% endif %}
            {% else %}
                -
            {% endif %}
        </div>
        <div style="font-size: 14px; color: var(--color-text-muted);">Average Accuracy</div>
    </div>
    <div style="background: var(--color-bg-secondary); border: 1px solid var(--color-border-light); border-radius: 12px; padding: 24px; transition: all 0.3s ease;"
         onmouseover="this.style.borderColor='var(--color-border-primary)'; this.style.transform='translateY(-4px)';"
         onmouseout="this.style.borderColor='var(--color-border-light)'; this.style.transform='translateY(0)';">
        <div style="font-size: 32px; margin-bottom: 12px;">âš ï¸</div>
        <div style="font-size: 28px; font-weight: 800; margin-bottom: 4px;">{{ decks_needing_attention | length }}</div>
        <div style="font-size: 14px; color: var(--color-text-muted);">Decks Need Review</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if deck_stats %}
            FlashFlow.showToast('Welcome back! You have {{ deck_stats|length }} active deck{{ "s" if deck_stats|length != 1 else "" }}.', 'info', 4000);
        {% endif %}

        {% if decks_needing_attention %}
            setTimeout(() => {
                FlashFlow.showToast('âš ï¸ {{ decks_needing_attention|length }} deck{{ "s" if decks_needing_attention|length != 1 else "" }} need{{ "" if decks_needing_attention|length != 1 else "s" }} review!', 'warning', 5000);
            }, 2000);
        {% endif %}
    });
</script>

<style>
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
    }
</style>
{% endblock %}
