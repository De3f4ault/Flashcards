<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if title %}{{ title }} - {% endif %}FlashFlow</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Bootstrap Grid Only (for layout) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap-grid.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- FlashFlow CSS - Card Carousel Design System -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layouts.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/utilities.css') }}">

    <!-- Page-specific CSS -->
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="logo">
            <a href="{{ url_for('main.index') }}" style="text-decoration: none; color: inherit;">
                FlashFlow
            </a>
        </div>

        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle hide-desktop"
                style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 8px;"
                onclick="toggleMobileMenu()"
                aria-label="Toggle menu">
            ‚ò∞
        </button>

        <div class="nav-links" id="navLinks">
            {% if current_user.is_authenticated %}
                <a href="{{ url_for('main.dashboard') }}"
                   class="nav-link {% if request.endpoint == 'main.dashboard' %}active{% endif %}">
                    Dashboard
                </a>
                <a href="{{ url_for('decks.index') }}"
                   class="nav-link {% if request.endpoint and 'decks' in request.endpoint %}active{% endif %}">
                    My Decks
                </a>
                <a href="{{ url_for('decks.public') }}"
                   class="nav-link {% if request.endpoint == 'decks.public' %}active{% endif %}">
                    Explore
                </a>
                <a href="{{ url_for('documents.library') }}"
                   class="nav-link {% if request.endpoint and 'documents' in request.endpoint %}active{% endif %}"
                   title="My Documents">
                    Documents
                </a>
                <a href="{{ url_for('chat.index') }}"
                   class="nav-link {% if request.endpoint and 'chat' in request.endpoint %}active{% endif %}"
                   title="AI Chat">
                    AI Chat
                </a>
                <a href="{{ url_for('mc_metrics.dashboard') }}"
                   class="nav-link {% if request.endpoint and 'mc_metrics' in request.endpoint %}active{% endif %}"
                   title="Metrics">
                    Analytics
                </a>

                <div class="search-container">
                    <span class="search-icon" title="Search decks">üîç</span>
                </div>

                <a href="{{ url_for('auth.profile') }}" class="profile-icon" title="{{ current_user.username }}">
                    {{ current_user.username[0].upper() }}
                </a>
            {% else %}
                <a href="{{ url_for('decks.public') }}" class="nav-link">
                    Explore
                </a>
                <a href="{{ url_for('main.about') }}" class="nav-link">
                    About
                </a>
                <a href="{{ url_for('main.help') }}" class="nav-link">
                    Help
                </a>
                <a href="{{ url_for('auth.login') }}" class="btn btn-secondary btn-sm">
                    Login
                </a>
                <a href="{{ url_for('auth.register') }}" class="btn btn-primary btn-sm">
                    Sign Up
                </a>
            {% endif %}
        </div>
    </nav>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div style="padding-top: 80px;">
                <div class="container">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} animate-fadeIn"
                             data-auto-dismiss="true"
                             role="alert">
                            {{ message }}
                            <button type="button"
                                    class="btn-close"
                                    style="background: none; border: none; color: inherit; opacity: 0.7; cursor: pointer; float: right; font-size: 1.5rem; line-height: 1; margin-left: 16px;"
                                    onclick="this.parentElement.style.display='none'"
                                    aria-label="Close">
                                &times;
                            </button>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    {% endwith %}

    <!-- Hero Section Block (optional - for dashboard/landing pages) -->
    {% block hero %}{% endblock %}

    <!-- Main Content -->
    <main class="main-content">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-text">
                    &copy; 2025 FlashFlow. Built with Flask and powered by AI.
                </div>
                <div class="footer-links">
                    <a href="{{ url_for('main.about') }}" class="footer-link">About</a>
                    <a href="{{ url_for('main.help') }}" class="footer-link">Help</a>
                    <a href="#" class="footer-link">Contact</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS (for collapsible nav on mobile) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>

    <!-- Global initialization -->
    <script>
        // Make CSRF token available for AJAX requests
        if (window.FlashFlow) {
            window.csrfToken = FlashFlow.getCSRFToken();
        }

        /**
         * Toggle mobile navigation menu
         */
        function toggleMobileMenu() {
            const navLinks = document.getElementById('navLinks');
            const isVisible = navLinks.style.display === 'flex' && navLinks.style.position === 'absolute';

            if (isVisible) {
                // Hide menu
                navLinks.style.display = '';
                navLinks.style.position = '';
                navLinks.style.top = '';
                navLinks.style.right = '';
                navLinks.style.background = '';
                navLinks.style.padding = '';
                navLinks.style.borderRadius = '';
                navLinks.style.boxShadow = '';
                navLinks.style.minWidth = '';
                navLinks.style.flexDirection = '';
            } else {
                // Show menu
                navLinks.style.display = 'flex';
                navLinks.style.flexDirection = 'column';
                navLinks.style.position = 'absolute';
                navLinks.style.top = '70px';
                navLinks.style.right = '20px';
                navLinks.style.background = 'var(--color-bg-secondary)';
                navLinks.style.padding = '20px';
                navLinks.style.borderRadius = 'var(--radius-lg)';
                navLinks.style.boxShadow = 'var(--shadow-xl)';
                navLinks.style.minWidth = '200px';
                navLinks.style.zIndex = 'var(--z-dropdown)';
                navLinks.style.border = '1px solid var(--color-border-light)';
            }
        }

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            // Handle logout confirmation
            const logoutLinks = document.querySelectorAll('a[href*="logout"]');
            logoutLinks.forEach(link => {
                link.addEventListener('click', async function(e) {
                    e.preventDefault();
                    if (window.FlashFlow && window.FlashFlow.confirmDialog) {
                        const confirmed = await FlashFlow.confirmDialog('Are you sure you want to log out?');
                        if (confirmed) {
                            window.location.href = this.href;
                        }
                    } else {
                        // Fallback to native confirm if FlashFlow not loaded
                        if (confirm('Are you sure you want to log out?')) {
                            window.location.href = this.href;
                        }
                    }
                });
            });

            // Close mobile menu when clicking outside
            document.addEventListener('click', function(e) {
                const navLinks = document.getElementById('navLinks');
                const toggle = document.querySelector('.mobile-menu-toggle');

                if (navLinks && toggle &&
                    !navLinks.contains(e.target) &&
                    !toggle.contains(e.target) &&
                    window.innerWidth <= 768) {
                    // Reset mobile menu styles
                    const isVisible = navLinks.style.display === 'flex' && navLinks.style.position === 'absolute';
                    if (isVisible) {
                        navLinks.style.display = '';
                        navLinks.style.position = '';
                        navLinks.style.top = '';
                        navLinks.style.right = '';
                        navLinks.style.background = '';
                        navLinks.style.padding = '';
                        navLinks.style.borderRadius = '';
                        navLinks.style.boxShadow = '';
                        navLinks.style.minWidth = '';
                        navLinks.style.flexDirection = '';
                        navLinks.style.zIndex = '';
                        navLinks.style.border = '';
                    }
                }
            });

            // Handle window resize - reset mobile menu on desktop
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    const navLinks = document.getElementById('navLinks');
                    if (window.innerWidth > 768 && navLinks) {
                        // Reset all mobile menu styles on desktop
                        navLinks.style.display = '';
                        navLinks.style.position = '';
                        navLinks.style.top = '';
                        navLinks.style.right = '';
                        navLinks.style.background = '';
                        navLinks.style.padding = '';
                        navLinks.style.borderRadius = '';
                        navLinks.style.boxShadow = '';
                        navLinks.style.minWidth = '';
                        navLinks.style.flexDirection = '';
                        navLinks.style.zIndex = '';
                        navLinks.style.border = '';
                    }
                }, 250);
            });

            // Enhance form submissions with loading states
            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    const submitBtn = this.querySelector('button[type="submit"]');
                    if (submitBtn && !submitBtn.disabled && window.FlashFlow) {
                        FlashFlow.showButtonLoading(submitBtn);
                    }
                });
            });
        });
    </script>

    <!-- Page-specific scripts -->
    {% block scripts %}{% endblock %}
</body>
</html>
