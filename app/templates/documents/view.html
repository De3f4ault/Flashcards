{% extends "base.html" %}

{% block content %}
<div style="padding-top: 100px; padding-bottom: 60px;">
    <div class="container" style="max-width: 1200px;">
        <!-- Back Button -->
        <a href="{{ url_for('documents.library') }}" class="btn btn-secondary" style="margin-bottom: var(--space-md); display: inline-flex; align-items: center; gap: 8px;">
            ‚Üê Back to Library
        </a>

        <!-- Document Header Card -->
        <div style="background: var(--gradient-primary); border-radius: var(--radius-xl); padding: var(--space-xl); margin-bottom: var(--space-xl); position: relative; overflow: hidden; box-shadow: var(--shadow-primary);">
            <!-- Radial glow -->
            <div style="position: absolute; top: -50%; right: -50%; width: 400px; height: 400px; background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%); pointer-events: none;"></div>

            <div style="position: relative; z-index: 1; display: flex; justify-content: space-between; align-items: center; gap: var(--space-md); flex-wrap: wrap;">
                <div style="flex: 1; min-width: 300px;">
                    <div style="font-size: 48px; margin-bottom: var(--space-sm);">
                        {% if document.file_type == 'pdf' %}üìï
                        {% elif document.file_type == 'txt' %}üìÑ
                        {% elif document.file_type == 'epub' %}üìò
                        {% elif document.file_type == 'docx' %}üìó
                        {% else %}üìÑ
                        {% endif %}
                    </div>
                    <h1 style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); margin-bottom: 8px; color: white; word-break: break-word;">
                        {{ document.original_filename }}
                    </h1>
                    <p style="font-size: var(--font-size-md); color: rgba(255, 255, 255, 0.9); margin: 0;">
                        Uploaded {{ document.upload_date.strftime('%B %d, %Y') }}
                    </p>
                </div>
                <span style="flex-shrink: 0; padding: 8px 20px; border-radius: var(--radius-2xl); font-size: var(--font-size-sm); font-weight: var(--font-weight-bold); {% if document.processing_status == 'ready' %}background: rgba(52, 199, 89, 0.2); color: white; border: 1px solid rgba(52, 199, 89, 0.5);{% elif document.processing_status == 'uploading' %}background: rgba(234, 179, 8, 0.2); color: white; border: 1px solid rgba(234, 179, 8, 0.5);{% else %}background: rgba(239, 68, 68, 0.2); color: white; border: 1px solid rgba(239, 68, 68, 0.5);{% endif %}">
                    {{ document.processing_status|title }}
                </span>
            </div>
        </div>

        <!-- Error Message -->
        {% if document.error_message %}
        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--color-danger); border-left: 4px solid var(--color-danger); border-radius: var(--radius-lg); padding: var(--space-md); margin-bottom: var(--space-xl);">
            <h3 style="font-size: var(--font-size-md); font-weight: var(--font-weight-semibold); margin-bottom: 8px; color: var(--color-danger); display: flex; align-items: center; gap: 8px;">
                ‚ö†Ô∏è Processing Error
            </h3>
            <p style="color: var(--color-text-tertiary); margin: 0;">{{ document.error_message }}</p>
        </div>
        {% endif %}

        <!-- Document Information Grid -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-xl);">
            <!-- Document Info -->
            <div style="background: var(--color-bg-secondary); border: 1px solid var(--color-border-light); border-radius: var(--radius-lg); padding: var(--space-lg);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); margin-bottom: var(--space-md); color: var(--color-text-primary);">
                    üìã Document Information
                </h3>
                <div style="display: flex; flex-direction: column; gap: var(--space-sm); font-size: var(--font-size-sm);">
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--color-border-light);">
                        <span style="color: var(--color-text-muted);">File Name:</span>
                        <span style="color: var(--color-text-primary); font-weight: var(--font-weight-semibold); text-align: right; max-width: 200px; word-break: break-word;">{{ document.filename }}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--color-border-light);">
                        <span style="color: var(--color-text-muted);">File Type:</span>
                        <span style="padding: 2px 8px; background: rgba(59, 130, 246, 0.1); color: var(--color-info); border-radius: var(--radius-sm); font-weight: var(--font-weight-bold);">{{ document.file_type|upper }}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--color-border-light);">
                        <span style="color: var(--color-text-muted);">File Size:</span>
                        <span style="color: var(--color-text-primary); font-weight: var(--font-weight-semibold);">{{ document.get_file_size_formatted() }}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--color-border-light);">
                        <span style="color: var(--color-text-muted);">Uploaded:</span>
                        <span style="color: var(--color-text-primary); font-weight: var(--font-weight-semibold);">{{ document.upload_date.strftime('%B %d, %Y') }}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                        <span style="color: var(--color-text-muted);">Last Accessed:</span>
                        <span style="color: var(--color-text-primary); font-weight: var(--font-weight-semibold);">{{ document.last_accessed.strftime('%B %d, %Y') }}</span>
                    </div>
                </div>
            </div>

            <!-- Gemini Cache Status -->
            <div style="background: var(--color-bg-secondary); border: 1px solid var(--color-border-light); border-radius: var(--radius-lg); padding: var(--space-lg);">
                <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); margin-bottom: var(--space-md); color: var(--color-text-primary);">
                    ‚òÅÔ∏è Gemini Cache Status
                </h3>
                <div style="display: flex; flex-direction: column; gap: var(--space-sm); font-size: var(--font-size-sm);">
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--color-border-light);">
                        <span style="color: var(--color-text-muted);">Status:</span>
                        <span>
                            {% if document.gemini_file_uri %}
                                {% if document.is_gemini_cache_expired() %}
                                    <span style="padding: 2px 8px; background: rgba(239, 68, 68, 0.1); color: var(--color-danger); border-radius: var(--radius-sm); font-weight: var(--font-weight-bold);">Cache Expired</span>
                                {% else %}
                                    <span style="padding: 2px 8px; background: rgba(52, 199, 89, 0.1); color: var(--color-success); border-radius: var(--radius-sm); font-weight: var(--font-weight-bold);">Active</span>
                                {% endif %}
                            {% else %}
                                <span style="padding: 2px 8px; background: var(--overlay-medium); color: var(--color-text-tertiary); border-radius: var(--radius-sm); font-weight: var(--font-weight-bold);">Not Cached</span>
                            {% endif %}
                        </span>
                    </div>
                    {% if document.gemini_expires_at %}
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--color-border-light);">
                        <span style="color: var(--color-text-muted);">Expires:</span>
                        <span style="color: var(--color-text-primary); font-weight: var(--font-weight-semibold);">{{ document.gemini_expires_at.strftime('%B %d, %Y') }}</span>
                    </div>
                    {% endif %}
                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                        <span style="color: var(--color-text-muted);">Gemini File:</span>
                        <span style="color: var(--color-text-tertiary); font-size: var(--font-size-xs); text-align: right; max-width: 200px; word-break: break-all;">
                            {% if document.gemini_file_uri %}
                                {{ document.gemini_file_name }}
                            {% else %}
                                Not available
                            {% endif %}
                        </span>
                    </div>
                </div>

                {% if document.is_gemini_cache_expired() and document.gemini_file_uri %}
                <button class="btn btn-secondary" id="refreshCacheBtn" style="width: 100%; margin-top: var(--space-md); background: rgba(234, 179, 8, 0.1); color: var(--color-warning); border-color: rgba(234, 179, 8, 0.3);">
                    üîÑ Refresh Cache
                </button>
                <div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-top: 8px; text-align: center;">
                    Cache has expired. Refresh to use AI features.
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Usage Statistics -->
        <div style="margin-bottom: var(--space-xl);">
            <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); margin-bottom: var(--space-md); color: var(--color-text-primary);">
                üìä Usage Statistics
            </h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-sm);">
                <!-- Questions Generated -->
                <div style="background: var(--color-bg-secondary); border: 1px solid var(--color-border-light); border-radius: var(--radius-lg); padding: var(--space-md); text-align: center; transition: var(--transition-base);" onmouseover="this.style.transform='translateY(-4px)'; this.style.borderColor='var(--color-border-primary)'" onmouseout="this.style.transform=''; this.style.borderColor='var(--color-border-light)'">
                    <div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Questions Generated</div>
                    <div style="font-size: var(--font-size-3xl); font-weight: var(--font-weight-extrabold); color: var(--color-text-primary); margin-bottom: 8px;">{{ stats.questions_count or 0 }}</div>
                    {% if stats.questions_count > 0 %}
                    <a href="{{ url_for('documents.questions', id=document.id) }}" class="btn btn-primary" style="font-size: var(--font-size-sm); padding: 6px 12px;">
                        View Questions
                    </a>
                    {% else %}
                    <div style="font-size: var(--font-size-sm); color: var(--color-text-muted);">No questions yet</div>
                    {% endif %}
                </div>

                <!-- Chat Sessions -->
                <div style="background: var(--color-bg-secondary); border: 1px solid var(--color-border-light); border-radius: var(--radius-lg); padding: var(--space-md); text-align: center; transition: var(--transition-base);" onmouseover="this.style.transform='translateY(-4px)'; this.style.borderColor='var(--color-border-primary)'" onmouseout="this.style.transform=''; this.style.borderColor='var(--color-border-light)'">
                    <div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Chat Sessions</div>
                    <div style="font-size: var(--font-size-3xl); font-weight: var(--font-weight-extrabold); color: var(--color-text-primary); margin-bottom: 8px;">{{ stats.chat_sessions }}</div>
                    <div style="font-size: var(--font-size-sm); color: var(--color-text-muted);">Phase 2 Feature</div>
                </div>

                <!-- Total Accesses -->
                <div style="background: var(--color-bg-secondary); border: 1px solid var(--color-border-light); border-radius: var(--radius-lg); padding: var(--space-md); text-align: center; transition: var(--transition-base);" onmouseover="this.style.transform='translateY(-4px)'; this.style.borderColor='var(--color-border-primary)'" onmouseout="this.style.transform=''; this.style.borderColor='var(--color-border-light)'">
                    <div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Total Accesses</div>
                    <div style="font-size: var(--font-size-3xl); font-weight: var(--font-weight-extrabold); color: var(--color-text-primary); margin-bottom: 8px;">{{ stats.total_accesses }}</div>
                    <div style="font-size: var(--font-size-sm); color: var(--color-text-muted);">Coming Soon</div>
                </div>
            </div>
        </div>

        <!-- Generate Questions Section -->
        {% if document.processing_status == 'ready' and not document.is_gemini_cache_expired() %}
        <div style="background: var(--color-bg-secondary); border: 1px solid rgba(52, 199, 89, 0.3); border-radius: var(--radius-xl); padding: var(--space-xl); margin-bottom: var(--space-xl);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: var(--space-md);">
                <div style="width: 48px; height: 48px; border-radius: var(--radius-md); background: rgba(52, 199, 89, 0.1); display: flex; align-items: center; justify-content: center; font-size: 24px;">
                    ‚ùì
                </div>
                <h3 style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); margin: 0; color: var(--color-text-primary);">
                    Generate Questions
                </h3>
            </div>

            <form method="POST" action="{{ url_for('documents.generate_questions', id=document.id) }}" id="generateForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-md);">
                    <!-- Deck Selection -->
                    <div>
                        <label style="display: block; font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); margin-bottom: 6px; color: var(--color-text-secondary);">
                            Select Deck <span style="color: var(--color-danger);">*</span>
                        </label>
                        <select name="deck_id" id="deck_id" class="form-input" style="width: 100%;" required>
                            <option value="">-- Choose a deck --</option>
                            {% for deck in user_decks %}
                            <option value="{{ deck.id }}">{{ deck.name }}</option>
                            {% endfor %}
                        </select>
                        <div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-top: 4px;">Questions will be added to this deck</div>
                    </div>

                    <!-- Count -->
                    <div>
                        <label style="display: block; font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); margin-bottom: 6px; color: var(--color-text-secondary);">
                            Number of Questions <span style="color: var(--color-danger);">*</span>
                        </label>
                        <select name="count" id="count" class="form-input" style="width: 100%;" required>
                            <option value="5">5 Questions</option>
                            <option value="10" selected>10 Questions</option>
                            <option value="20">20 Questions</option>
                            <option value="50">50 Questions</option>
                        </select>
                    </div>

                    <!-- Difficulty -->
                    <div>
                        <label style="display: block; font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); margin-bottom: 6px; color: var(--color-text-secondary);">
                            Difficulty <span style="color: var(--color-danger);">*</span>
                        </label>
                        <select name="difficulty" id="difficulty" class="form-input" style="width: 100%;" required>
                            <option value="easy">Easy</option>
                            <option value="medium" selected>Medium</option>
                            <option value="hard">Hard</option>
                            <option value="expert">Expert</option>
                        </select>
                    </div>
                </div>

                <!-- Topics -->
                <div style="margin-bottom: var(--space-md);">
                    <label style="display: block; font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); margin-bottom: 6px; color: var(--color-text-secondary);">
                        Specific Topics (Optional)
                    </label>
                    <input type="text" name="topics" id="topics" class="form-input" style="width: 100%;" placeholder="e.g., SQL joins, database normalization">
                    <div style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-top: 4px;">Leave blank to generate questions from the entire document</div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: var(--space-sm); flex-wrap: wrap;">
                    <button type="submit" class="btn btn-primary" id="generateBtn">
                        ‚ú® Generate Questions
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('generationHelp').style.display = document.getElementById('generationHelp').style.display === 'none' ? 'block' : 'none'">
                        ‚ÑπÔ∏è Help
                    </button>
                </div>

                <!-- Help Section (Collapsible) -->
                <div id="generationHelp" style="display: none; margin-top: var(--space-md); background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: var(--radius-md); padding: var(--space-md);">
                    <h4 style="font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-sm); color: var(--color-text-primary);">Generation Tips:</h4>
                    <ul style="margin: 0; padding-left: 24px; color: var(--color-text-tertiary); font-size: var(--font-size-sm); line-height: 1.8;">
                        <li><strong style="color: var(--color-text-secondary);">Easy:</strong> Basic recall and comprehension questions</li>
                        <li><strong style="color: var(--color-text-secondary);">Medium:</strong> Application and understanding questions</li>
                        <li><strong style="color: var(--color-text-secondary);">Hard:</strong> Analysis and synthesis questions</li>
                        <li><strong style="color: var(--color-text-secondary);">Expert:</strong> Advanced application and evaluation questions</li>
                    </ul>
                    <p style="margin: var(--space-sm) 0 0; color: var(--color-text-tertiary); font-size: var(--font-size-sm);"><strong style="color: var(--color-text-secondary);">Topics:</strong> Use specific topics to focus questions on particular sections or concepts from your document.</p>
                </div>
            </form>
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div style="background: var(--color-bg-secondary); border: 1px solid var(--color-border-light); border-radius: var(--radius-lg); padding: var(--space-lg);">
            <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); margin-bottom: var(--space-md); color: var(--color-text-primary);">
                üéØ Actions
            </h3>
            <div style="display: flex; gap: var(--space-sm); flex-wrap: wrap;">
                {% if stats.questions_count > 0 %}
                <a href="{{ url_for('documents.questions', id=document.id) }}" class="btn btn-primary">
                    üìã View All Questions ({{ stats.questions_count }})
                </a>
                <a href="{{ url_for('documents.study', id=document.id) }}" class="btn btn-primary" style="background: rgba(52, 199, 89, 0.2); color: var(--color-success); border-color: rgba(52, 199, 89, 0.3);">
                    üéì Study Questions
                </a>
                {% endif %}

                <button class="btn btn-secondary" disabled style="opacity: 0.5;">
                    üí¨ Chat About Document
                </button>

                <form method="POST" action="{{ url_for('documents.delete', id=document.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this document? This will also delete all generated questions. This action cannot be undone.');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-secondary" style="background: rgba(239, 68, 68, 0.1); color: var(--color-danger); border-color: rgba(239, 68, 68, 0.3);">
                        üóëÔ∏è Delete Document
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    @media (max-width: 768px) {
        [style*="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr))"],
        [style*="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr))"] {
            grid-template-columns: 1fr !important;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.getElementById('refreshCacheBtn');
    const generateForm = document.getElementById('generateForm');
    const generateBtn = document.getElementById('generateBtn');

    if (refreshBtn) {
        refreshBtn.addEventListener('click', async function() {
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'üîÑ Refreshing...';

            try {
                const response = await fetch('{{ url_for("documents.refresh_cache", id=document.id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    FlashFlow.showToast('Cache refreshed successfully!', 'success', 3000);
                    setTimeout(() => location.reload(), 1000);
                } else {
                    FlashFlow.showToast('Failed to refresh cache: ' + data.error, 'error', 4000);
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'üîÑ Refresh Cache';
                }
            } catch (error) {
                FlashFlow.showToast('Error refreshing cache: ' + error.message, 'error', 4000);
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'üîÑ Refresh Cache';
            }
        });
    }

    if (generateForm) {
        generateForm.addEventListener('submit', function(e) {
            const deckId = document.getElementById('deck_id').value;
            if (!deckId) {
                e.preventDefault();
                FlashFlow.showToast('Please select a deck', 'warning', 3000);
                return false;
            }

            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span style="display: inline-block; width: 16px; height: 16px; border: 2px solid white; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> Generating...';
        });
    }

    // Show document info toast
    FlashFlow.showToast('Document details loaded successfully', 'success', 2000);
});
</script>
{% endblock %}
