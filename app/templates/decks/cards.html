{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h2 mb-1">Manage Cards</h1>
                <h5 class="text-muted">{{ deck.name }}</h5>
                <p class="text-muted">
                    {% if pagination %}
                        {{ pagination.total }} {{ 'card' if pagination.total == 1 else 'cards' }} in this deck
                    {% else %}
                        0 cards in this deck
                    {% endif %}
                </p>
            </div>
            <div>
                <div class="btn-group">
                    <a href="{{ url_for('decks.create_card', deck_id=deck.id) }}" class="btn btn-primary">
                        <i class="bi bi-plus me-1"></i>Add Card
                    </a>
                    <a href="{{ url_for('decks.bulk_create_cards', deck_id=deck.id) }}" class="btn btn-outline-primary">
                        <i class="bi bi-stack me-1"></i>Bulk Import
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search & Filter Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-funnel me-2"></i>Search & Filter
                </h6>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filterSection">
                    <i class="bi bi-chevron-down"></i>
                </button>
            </div>
            <div class="collapse show" id="filterSection">
                <div class="card-body">
                    <form method="GET" action="{{ url_for('decks.cards', deck_id=deck.id) }}">
                        <div class="row g-3">
                            <!-- Text Search -->
                            <div class="col-md-6">
                                <label for="query" class="form-label">Search Cards</label>
                                <input type="text" class="form-control" id="query" name="query"
                                       value="{{ query }}" placeholder="Search front or back...">
                            </div>

                            <!-- Learning State Filter -->
                            <div class="col-md-3">
                                <label for="learning_state" class="form-label">Learning State</label>
                                <select class="form-select" id="learning_state" name="learning_state">
                                    <option value="">All States</option>
                                    <option value="new" {% if learning_state == 'new' %}selected{% endif %}>New</option>
                                    <option value="learning" {% if learning_state == 'learning' %}selected{% endif %}>Learning</option>
                                    <option value="review" {% if learning_state == 'review' %}selected{% endif %}>Review</option>
                                    <option value="mastered" {% if learning_state == 'mastered' %}selected{% endif %}>Mastered</option>
                                </select>
                            </div>

                            <!-- Difficulty Filter -->
                            <div class="col-md-3">
                                <label for="difficulty" class="form-label">Difficulty</label>
                                <select class="form-select" id="difficulty" name="difficulty">
                                    <option value="">All Difficulties</option>
                                    <option value="easy" {% if difficulty == 'easy' %}selected{% endif %}>Easy</option>
                                    <option value="medium" {% if difficulty == 'medium' %}selected{% endif %}>Medium</option>
                                    <option value="hard" {% if difficulty == 'hard' %}selected{% endif %}>Hard</option>
                                </select>
                            </div>

                            <!-- Sort By -->
                            <div class="col-md-4">
                                <label for="sort_by" class="form-label">Sort By</label>
                                <select class="form-select" id="sort_by" name="sort_by">
                                    <option value="created_desc" {% if sort_by == 'created_desc' %}selected{% endif %}>Newest First</option>
                                    <option value="created_asc" {% if sort_by == 'created_asc' %}selected{% endif %}>Oldest First</option>
                                    <option value="alpha_asc" {% if sort_by == 'alpha_asc' %}selected{% endif %}>A-Z</option>
                                    <option value="alpha_desc" {% if sort_by == 'alpha_desc' %}selected{% endif %}>Z-A</option>
                                    <option value="accuracy_high" {% if sort_by == 'accuracy_high' %}selected{% endif %}>Highest Accuracy</option>
                                    <option value="accuracy_low" {% if sort_by == 'accuracy_low' %}selected{% endif %}>Lowest Accuracy</option>
                                    <option value="studied_most" {% if sort_by == 'studied_most' %}selected{% endif %}>Most Studied</option>
                                    <option value="studied_least" {% if sort_by == 'studied_least' %}selected{% endif %}>Least Studied</option>
                                    <option value="difficulty_high" {% if sort_by == 'difficulty_high' %}selected{% endif %}>Hardest First</option>
                                    <option value="difficulty_low" {% if sort_by == 'difficulty_low' %}selected{% endif %}>Easiest First</option>
                                    <option value="due_soon" {% if sort_by == 'due_soon' %}selected{% endif %}>Due Soonest</option>
                                </select>
                            </div>

                            <!-- Date From -->
                            <div class="col-md-4">
                                <label for="date_from" class="form-label">Created From</label>
                                <input type="date" class="form-control" id="date_from" name="date_from" value="{{ date_from }}">
                            </div>

                            <!-- Date To -->
                            <div class="col-md-4">
                                <label for="date_to" class="form-label">Created To</label>
                                <input type="date" class="form-control" id="date_to" name="date_to" value="{{ date_to }}">
                            </div>

                            <!-- Action Buttons -->
                            <div class="col-12">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-search me-1"></i>Apply Filters
                                    </button>
                                    <a href="{{ url_for('decks.cards', deck_id=deck.id) }}" class="btn btn-outline-secondary">
                                        <i class="bi bi-x-circle me-1"></i>Clear All
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Active Filters Display -->
{% if active_filters %}
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex gap-2 flex-wrap align-items-center">
            <span class="text-muted">Active filters:</span>
            {% for filter in active_filters %}
            <span class="badge bg-info">{{ filter }}</span>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Statistics Sidebar (Optional Collapsible) -->
{% if deck_stats %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 col-md-2">
                        <div class="fw-bold text-primary">{{ deck_stats.total }}</div>
                        <small class="text-muted">Total</small>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="fw-bold text-secondary">{{ deck_stats.new }}</div>
                        <small class="text-muted">New</small>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="fw-bold text-warning">{{ deck_stats.learning }}</div>
                        <small class="text-muted">Learning</small>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="fw-bold text-info">{{ deck_stats.review }}</div>
                        <small class="text-muted">Review</small>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="fw-bold text-success">{{ deck_stats.mastered }}</div>
                        <small class="text-muted">Mastered</small>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="fw-bold text-danger">{{ deck_stats.due_today }}</div>
                        <small class="text-muted">Due Today</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Cards Grid -->
{% if cards %}
<div class="row">
    {% for card in cards %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100 {% if card.is_due_for_review() %}border-warning{% endif %}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="d-flex gap-2 flex-wrap">
                        <!-- Learning State Badge -->
                        {% if card.learning_state == 'new' %}
                            <span class="badge bg-secondary">New</span>
                        {% elif card.learning_state == 'learning' %}
                            <span class="badge bg-warning">Learning</span>
                        {% elif card.learning_state == 'review' %}
                            <span class="badge bg-info">Review</span>
                        {% elif card.learning_state == 'mastered' %}
                            <span class="badge bg-success">Mastered</span>
                        {% endif %}

                        <!-- Due Badge -->
                        {% if card.is_due_for_review() %}
                            <span class="badge bg-danger">Due</span>
                        {% endif %}
                    </div>

                    <div class="d-flex gap-1">
                        <!-- Difficulty Indicator (Ease Factor) -->
                        {% if card.ease_factor %}
                            {% if card.ease_factor >= 2.5 %}
                                <span class="badge bg-success" title="Ease Factor: {{ card.ease_factor }}">Easy</span>
                            {% elif card.ease_factor >= 2.0 %}
                                <span class="badge bg-warning" title="Ease Factor: {{ card.ease_factor }}">Medium</span>
                            {% else %}
                                <span class="badge bg-danger" title="Ease Factor: {{ card.ease_factor }}">Hard</span>
                            {% endif %}
                        {% endif %}

                        <!-- Accuracy Badge -->
                        {% if card.times_studied > 0 %}
                            {% set accuracy = (card.times_correct / card.times_studied * 100) | int %}
                            {% if accuracy >= 80 %}
                                <span class="badge bg-success">{{ accuracy }}%</span>
                            {% elif accuracy >= 50 %}
                                <span class="badge bg-warning">{{ accuracy }}%</span>
                            {% else %}
                                <span class="badge bg-danger">{{ accuracy }}%</span>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>

                <div class="mb-3">
                    <div class="small fw-bold text-muted mb-1">FRONT:</div>
                    <div class="mb-2">{{ card.front }}</div>
                    <div class="small fw-bold text-muted mb-1">BACK:</div>
                    <div class="text-muted">{{ card.back }}</div>
                </div>

                <div class="small text-muted mb-3">
                    <i class="bi bi-eye me-1"></i>{{ card.times_studied }} {{ 'study' if card.times_studied == 1 else 'studies' }}
                    {% if card.times_studied > 0 %}
                        <span class="mx-2">•</span>
                        <i class="bi bi-check-circle me-1"></i>{{ card.times_correct }} correct
                    {% endif %}
                    {% if card.next_review_date %}
                        <span class="mx-2">•</span>
                        <i class="bi bi-calendar me-1"></i>
                        {% set days_until = card.days_until_due() %}
                        {% if days_until == 0 %}
                            Due today
                        {% elif days_until < 0 %}
                            {{ days_until|abs }} days overdue
                        {% else %}
                            Due in {{ days_until }} {{ 'day' if days_until == 1 else 'days' }}
                        {% endif %}
                    {% endif %}
                </div>

                <div class="d-flex gap-2">
                    <a href="{{ url_for('decks.edit_card', deck_id=deck.id, card_id=card.id) }}"
                       class="btn btn-outline-primary btn-sm flex-fill">
                        <i class="bi bi-pencil me-1"></i>Edit
                    </a>
                    <form method="POST" action="{{ url_for('decks.delete_card', deck_id=deck.id, card_id=card.id) }}"
                          onsubmit="return confirm('Delete this card?')" class="d-inline">
                        <button type="submit" class="btn btn-outline-danger btn-sm">
                            <i class="bi bi-trash me-1"></i>Delete
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if pagination and pagination.pages > 1 %}
<div class="row mt-4">
    <div class="col-12">
        <nav aria-label="Cards pagination">
            <ul class="pagination justify-content-center">
                {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('decks.cards', deck_id=deck.id, page=pagination.prev_num,
                            query=query, learning_state=learning_state, difficulty=difficulty, sort_by=sort_by,
                            date_from=date_from, date_to=date_to) }}">
                            <i class="bi bi-chevron-left"></i> Previous
                        </a>
                    </li>
                {% endif %}

                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('decks.cards', deck_id=deck.id, page=page_num,
                                query=query, learning_state=learning_state, difficulty=difficulty, sort_by=sort_by,
                                date_from=date_from, date_to=date_to) }}">
                                {{ page_num }}
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('decks.cards', deck_id=deck.id, page=pagination.next_num,
                            query=query, learning_state=learning_state, difficulty=difficulty, sort_by=sort_by,
                            date_from=date_from, date_to=date_to) }}">
                            Next <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>

        <p class="text-center text-muted small">
            Showing {{ ((pagination.page - 1) * pagination.per_page) + 1 }} -
            {{ min(pagination.page * pagination.per_page, pagination.total) }} of {{ pagination.total }}
        </p>
    </div>
</div>
{% endif %}

{% else %}
<!-- Empty State -->
<div class="row">
    <div class="col-12">
        <div class="text-center py-5">
            {% if query or learning_state or difficulty or date_from or date_to %}
                <!-- No Results -->
                <i class="bi bi-search display-1 text-muted mb-3"></i>
                <h4 class="text-muted">No cards found</h4>
                <p class="text-muted">Try adjusting your filters or search terms</p>
                <a href="{{ url_for('decks.cards', deck_id=deck.id) }}" class="btn btn-primary">
                    <i class="bi bi-x-circle me-2"></i>Clear Filters
                </a>
            {% else %}
                <!-- No Cards -->
                <i class="bi bi-card-text display-1 text-muted mb-3"></i>
                <h4 class="text-muted">No cards yet</h4>
                <p class="text-muted">Add your first flashcard to start building this deck!</p>
                <div class="d-flex justify-content-center gap-3">
                    <a href="{{ url_for('decks.create_card', deck_id=deck.id) }}" class="btn btn-primary">
                        <i class="bi bi-plus me-2"></i>Add Card
                    </a>
                    <a href="{{ url_for('decks.view', id=deck.id) }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Back to Deck
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
