{% extends "base.html" %}

{% block content %}
<div style="min-height: 100vh; display: flex; flex-direction: column; padding-top: calc(var(--navbar-height) + var(--space-md)); padding-bottom: var(--space-2xl);">
    <div class="container" style="max-width: 900px;">

        <!-- Progress Bar -->
        <div style="background: var(--color-bg-secondary); border: 1px solid var(--color-border-light); border-radius: var(--radius-xl); padding: var(--space-md); margin-bottom: var(--space-md); box-shadow: var(--shadow-md);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <span style="font-weight: var(--font-weight-semibold); color: var(--color-primary); display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 20px;">üìä</span> Progress
                </span>
                <span style="color: var(--color-text-tertiary); font-size: var(--font-size-sm);">
                    Card <strong style="color: var(--color-text-primary);">{{ progress.current }}</strong> of <strong style="color: var(--color-text-primary);">{{ progress.total }}</strong>
                </span>
            </div>

            <!-- Progress Bar -->
            <div style="height: 8px; background: var(--overlay-medium); border-radius: 4px; overflow: hidden; position: relative;">
                <div style="height: 100%; background: var(--gradient-primary); border-radius: 4px; width: {{ progress.percentage }}%; transition: width 0.5s ease;"></div>
            </div>

            <div style="text-align: center; margin-top: 8px;">
                <span style="color: var(--color-text-muted); font-size: var(--font-size-sm);">{{ progress.percentage }}% Complete</span>
            </div>
        </div>

        <!-- Study Mode Toggle -->
        <div style="text-align: center; margin-bottom: var(--space-md);">
            <div style="display: inline-flex; background: var(--color-bg-secondary); border: 1px solid var(--color-border-light); border-radius: var(--radius-lg); padding: 4px; box-shadow: var(--shadow-sm);">
                <input type="radio" id="flipMode" name="studyMode" {% if preferred_mode == 'flip' %}checked{% endif %} onchange="switchMode('flip')" style="display: none;">
                <label for="flipMode" style="padding: 12px 24px; cursor: pointer; border-radius: var(--radius-md); transition: var(--transition-base); font-weight: var(--font-weight-semibold); font-size: var(--font-size-base); display: flex; align-items: center; gap: 8px;">
                    <span>üé¥</span> Flip Card
                </label>

                <input type="radio" id="typeMode" name="studyMode" {% if preferred_mode == 'type' %}checked{% endif %} onchange="switchMode('type')" style="display: none;">
                <label for="typeMode" style="padding: 12px 24px; cursor: pointer; border-radius: var(--radius-md); transition: var(--transition-base); font-weight: var(--font-weight-semibold); font-size: var(--font-size-base); display: flex; align-items: center; gap: 8px;">
                    <span>‚å®Ô∏è</span> Type Answer
                </label>
            </div>
        </div>

        <!-- Flashcard Container -->
        <div id="flashcard" style="background: var(--color-bg-secondary); border: 1px solid var(--color-border-light); border-radius: var(--radius-xl); padding: var(--space-2xl) var(--space-xl); box-shadow: var(--shadow-xl); min-height: 500px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; position: relative; overflow: hidden; transition: var(--transition-base);">

            <!-- Gradient Background Effect -->
            <div style="position: absolute; top: -50%; right: -50%; width: 400px; height: 400px; background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%); pointer-events: none;"></div>

            <div style="position: relative; z-index: 1; width: 100%;">
                <!-- Card Header Badges -->
                <div style="margin-bottom: var(--space-md); display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;">
                    <span class="badge badge-primary" style="padding: 8px 16px; font-size: var(--font-size-sm);">
                        <span style="margin-right: 6px;">‚ùì</span>Question {{ progress.current }}
                    </span>
                    <span class="badge {% if card.difficulty == 1 %}badge-success{% elif card.difficulty == 2 %}badge-warning{% else %}badge-danger{% endif %}" style="padding: 8px 16px; font-size: var(--font-size-sm);">
                        {% if card.difficulty == 1 %}üü¢ Easy
                        {% elif card.difficulty == 2 %}üü° Medium
                        {% else %}üî¥ Hard
                        {% endif %}
                    </span>
                </div>

                <!-- FLIP MODE -->
                <div id="flip-mode-container">
                    <!-- Card Front -->
                    <div id="card-front" class="card-face">
                        <div style="font-size: 80px; margin-bottom: var(--space-md); animation: float 3s ease-in-out infinite;">üéØ</div>

                        <h3 style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); line-height: var(--line-height-normal); margin-bottom: var(--space-xl); color: var(--color-text-primary); max-width: 600px; margin-left: auto; margin-right: auto;">
                            {{ card.front_text }}
                        </h3>

                        <button class="btn btn-primary btn-lg" onclick="flipCard()" style="box-shadow: var(--shadow-primary);">
                            <span style="margin-right: 8px;">üëÅÔ∏è</span>Reveal Answer
                        </button>

                        <div style="margin-top: var(--space-sm);">
                            <small style="color: var(--color-text-muted);">Press Space or click anywhere to flip</small>
                        </div>
                    </div>

                    <!-- Card Back -->
                    <div id="card-back" class="card-face" style="display: none;">
                        <div style="font-size: 80px; margin-bottom: var(--space-md); animation: float 3s ease-in-out infinite;">üí°</div>

                        <div style="background: rgba(52, 199, 89, 0.1); border: 2px solid rgba(52, 199, 89, 0.3); border-radius: var(--radius-lg); padding: var(--space-lg); margin-bottom: var(--space-xl); max-width: 600px; margin-left: auto; margin-right: auto;">
                            <h6 style="text-transform: uppercase; font-size: var(--font-size-sm); color: var(--color-success); margin-bottom: 12px; font-weight: var(--font-weight-bold);">Answer</h6>
                            <h3 style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-success); line-height: var(--line-height-normal);">
                                {{ card.back_text }}
                            </h3>
                        </div>

                        <div>
                            <h6 style="margin-bottom: var(--space-md); font-weight: var(--font-weight-semibold); color: var(--color-text-secondary);">How well did you know this?</h6>
                            <div style="display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;">
                                <button class="btn" onclick="submitAnswer(false)" style="background: rgba(239, 68, 68, 0.2); border: 2px solid var(--color-danger); color: var(--color-danger); padding: 14px 28px; font-weight: var(--font-weight-bold);">
                                    <span style="margin-right: 8px;">‚ùå</span>Incorrect
                                </button>
                                <button class="btn" onclick="submitAnswer(true)" style="background: rgba(52, 199, 89, 0.2); border: 2px solid var(--color-success); color: var(--color-success); padding: 14px 28px; font-weight: var(--font-weight-bold);">
                                    <span style="margin-right: 8px;">‚úÖ</span>Correct
                                </button>
                            </div>
                            <div style="margin-top: var(--space-sm);">
                                <small style="color: var(--color-text-muted);">Press 1 for Incorrect, 2 for Correct</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TYPE MODE -->
                <div id="type-mode-container" style="display: none;">
                    <!-- Question State -->
                    <div id="type-question-state">
                        <div style="font-size: 80px; margin-bottom: var(--space-md); animation: float 3s ease-in-out infinite;">‚úèÔ∏è</div>

                        <h3 style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); line-height: var(--line-height-normal); margin-bottom: var(--space-xl); color: var(--color-text-primary); max-width: 600px; margin-left: auto; margin-right: auto;">
                            {{ card.front_text }}
                        </h3>

                        <div style="margin-bottom: var(--space-md); max-width: 500px; margin-left: auto; margin-right: auto;">
                            <input type="text" class="form-input" id="userAnswer" placeholder="Type your answer here..." autocomplete="off" autofocus style="text-align: center; font-size: var(--font-size-lg); padding: 16px; border: 2px solid var(--color-border-medium);">
                            <div style="margin-top: var(--space-xs);">
                                <small style="color: var(--color-text-muted);">Press Enter to check your answer</small>
                            </div>
                        </div>

                        <button class="btn btn-primary btn-lg" onclick="checkTypedAnswer()">
                            <span style="margin-right: 8px;">‚úì</span>Check Answer
                        </button>
                    </div>

                    <!-- Result State -->
                    <div id="type-result-state" style="display: none;">
                        <div id="result-emoji" style="font-size: 80px; margin-bottom: var(--space-md);"></div>

                        <div id="result-feedback" style="margin-bottom: var(--space-md);"></div>

                        <div style="margin-bottom: var(--space-xl); max-width: 500px; margin-left: auto; margin-right: auto;">
                            <div style="margin-bottom: var(--space-md);">
                                <h6 style="text-transform: uppercase; font-size: var(--font-size-xs); color: var(--color-text-muted); margin-bottom: 8px; font-weight: var(--font-weight-semibold);">Your Answer</h6>
                                <div style="background: var(--overlay-light); border: 2px solid var(--color-border-medium); border-radius: var(--radius-md); padding: var(--space-md); min-height: 60px; display: flex; align-items: center; justify-content: center;">
                                    <span id="user-answer-text" style="font-weight: var(--font-weight-semibold);"></span>
                                </div>
                            </div>

                            <div>
                                <h6 style="text-transform: uppercase; font-size: var(--font-size-xs); color: var(--color-success); margin-bottom: 8px; font-weight: var(--font-weight-semibold);">Correct Answer</h6>
                                <div style="background: rgba(52, 199, 89, 0.1); border: 2px solid var(--color-success); border-radius: var(--radius-md); padding: var(--space-md); min-height: 60px; display: flex; align-items: center; justify-content: center;">
                                    <span style="color: var(--color-success); font-weight: var(--font-weight-bold);">{{ card.back_text }}</span>
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-primary btn-lg" onclick="nextCardFromType()">
                            <span style="margin-right: 8px;">‚Üí</span>Next Card
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Statistics -->
        <div style="background: var(--color-bg-secondary); border: 1px solid var(--color-border-light); border-radius: var(--radius-xl); padding: var(--space-lg); margin-top: var(--space-md); box-shadow: var(--shadow-md);">
            <h6 style="text-align: center; margin-bottom: var(--space-md); color: var(--color-text-tertiary); text-transform: uppercase; font-size: var(--font-size-sm); font-weight: var(--font-weight-bold);">Session Stats</h6>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--space-sm);">
                <div style="background: rgba(52, 199, 89, 0.1); border: 1px solid rgba(52, 199, 89, 0.3); border-radius: var(--radius-lg); padding: var(--space-md); text-align: center; transition: var(--transition-base);">
                    <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-extrabold); color: var(--color-success); margin-bottom: 4px;">
                        {{ session_stats.correct_count }}
                    </div>
                    <div style="font-size: var(--font-size-sm); color: var(--color-success); font-weight: var(--font-weight-semibold); display: flex; align-items: center; justify-content: center; gap: 4px;">
                        <span>‚úì</span>Correct
                    </div>
                </div>
                <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: var(--radius-lg); padding: var(--space-md); text-align: center; transition: var(--transition-base);">
                    <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-extrabold); color: var(--color-danger); margin-bottom: 4px;">
                        {{ session_stats.total_studied - session_stats.correct_count }}
                    </div>
                    <div style="font-size: var(--font-size-sm); color: var(--color-danger); font-weight: var(--font-weight-semibold); display: flex; align-items: center; justify-content: center; gap: 4px;">
                        <span>‚úó</span>Incorrect
                    </div>
                </div>
                <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: var(--radius-lg); padding: var(--space-md); text-align: center; transition: var(--transition-base);">
                    <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-extrabold); color: var(--color-info); margin-bottom: 4px;">
                        {{ session_stats.total_studied }}
                    </div>
                    <div style="font-size: var(--font-size-sm); color: var(--color-info); font-weight: var(--font-weight-semibold); display: flex; align-items: center; justify-content: center; gap: 4px;">
                        <span>üìã</span>Total
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: var(--space-md); gap: 12px; flex-wrap: wrap;">
            <a href="{{ url_for('study.start', deck_id=deck.id) }}" class="btn btn-secondary">
                <span style="margin-right: 8px;">‚Üê</span>Back to Options
            </a>
            <a href="{{ url_for('decks.view', id=deck.id) }}" class="btn btn-secondary">
                <span style="margin-right: 8px;">üè†</span>Deck Home
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        50% { transform: translateX(10px); }
        75% { transform: translateX(-5px); }
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .shake {
        animation: shake 0.5s;
    }

    .pulse {
        animation: pulse 0.5s;
    }

    .card-face {
        width: 100%;
        transition: opacity 0.3s ease;
    }

    #flashcard.clickable {
        cursor: pointer;
    }

    #flashcard:hover.clickable {
        border-color: var(--color-border-primary);
    }

    /* Mode toggle styling */
    input[type="radio"]:checked + label {
        background: var(--gradient-primary);
        color: var(--color-text-primary);
    }

    input[type="radio"]:not(:checked) + label {
        color: var(--color-text-tertiary);
    }

    input[type="radio"]:not(:checked) + label:hover {
        background: var(--overlay-light);
        color: var(--color-text-primary);
    }

    /* Loading overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 15, 15, 0.95);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    }

    /* Responsive */
    @media (max-width: 768px) {
        #flashcard {
            padding: var(--space-lg) var(--space-md);
            min-height: 400px;
        }

        h3 {
            font-size: var(--font-size-xl) !important;
        }

        .btn-lg {
            padding: 12px 24px !important;
            font-size: var(--font-size-base) !important;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
const flashcard = document.getElementById('flashcard');
const cardFront = document.getElementById('card-front');
const cardBack = document.getElementById('card-back');
const flipModeContainer = document.getElementById('flip-mode-container');
const typeModeContainer = document.getElementById('type-mode-container');
const userAnswerInput = document.getElementById('userAnswer');
const correctAnswer = "{{ card.back_text }}";

let isFlipped = false;
let currentMode = '{{ preferred_mode|default("flip") }}';
let typedAnswerCorrect = false;

// Initialize with preferred mode on page load
document.addEventListener('DOMContentLoaded', function() {
    if (currentMode === 'type') {
        switchMode('type');
    }

    FlashFlow.showToast('Study session in progress!', 'info', 3000);
});

// Mode switching
function switchMode(mode) {
    currentMode = mode;

    if (mode === 'flip') {
        flipModeContainer.style.display = 'block';
        typeModeContainer.style.display = 'none';
        flashcard.classList.add('clickable');
        resetFlipMode();
    } else {
        flipModeContainer.style.display = 'none';
        typeModeContainer.style.display = 'block';
        flashcard.classList.remove('clickable');
        resetTypeMode();
        setTimeout(() => userAnswerInput.focus(), 100);
    }
}

function resetFlipMode() {
    isFlipped = false;
    cardFront.style.display = 'block';
    cardBack.style.display = 'none';
    cardFront.style.opacity = '1';
    cardBack.style.opacity = '1';
}

function resetTypeMode() {
    document.getElementById('type-question-state').style.display = 'block';
    document.getElementById('type-result-state').style.display = 'none';
    userAnswerInput.value = '';
}

// Flip mode functionality
flashcard.addEventListener('click', (e) => {
    if (currentMode === 'flip' && !e.target.closest('button')) {
        flipCard();
    }
});

document.addEventListener('keydown', (e) => {
    if (currentMode === 'flip') {
        if (e.key === ' ' || e.key === 'Enter') {
            e.preventDefault();
            if (!isFlipped) {
                flipCard();
            }
        } else if (isFlipped) {
            if (e.key === '1' || e.key === 'x') {
                e.preventDefault();
                submitAnswer(false);
            } else if (e.key === '2' || e.key === 'c') {
                e.preventDefault();
                submitAnswer(true);
            }
        }
    }
});

function flipCard() {
    isFlipped = !isFlipped;

    cardFront.style.opacity = '0';
    cardBack.style.opacity = '0';

    setTimeout(() => {
        if (isFlipped) {
            cardFront.style.display = 'none';
            cardBack.style.display = 'block';
        } else {
            cardFront.style.display = 'block';
            cardBack.style.display = 'none';
        }

        setTimeout(() => {
            cardFront.style.opacity = '1';
            cardBack.style.opacity = '1';
        }, 50);
    }, 200);
}

// Type mode functionality
userAnswerInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        checkTypedAnswer();
    }
});

function checkTypedAnswer() {
    const userAnswer = userAnswerInput.value.trim();

    if (!userAnswer) {
        userAnswerInput.classList.add('shake');
        userAnswerInput.style.borderColor = 'var(--color-danger)';
        setTimeout(() => {
            userAnswerInput.classList.remove('shake');
            userAnswerInput.style.borderColor = 'var(--color-border-medium)';
        }, 500);
        return;
    }

    // Compare answers (case-insensitive, trimmed)
    const isCorrect = compareAnswers(userAnswer, correctAnswer);
    typedAnswerCorrect = isCorrect;

    // Show result
    document.getElementById('type-question-state').style.display = 'none';
    document.getElementById('type-result-state').style.display = 'block';

    // Update result display
    const resultEmoji = document.getElementById('result-emoji');
    const resultFeedback = document.getElementById('result-feedback');
    const userAnswerText = document.getElementById('user-answer-text');

    if (isCorrect) {
        resultEmoji.textContent = 'üéâ';
        resultFeedback.innerHTML = '<div class="alert alert-success"><strong>‚úì Correct!</strong> Great job!</div>';
        flashcard.classList.add('pulse');
        FlashFlow.showToast('Correct! üéâ', 'success', 2000);
    } else {
        resultEmoji.textContent = 'üòî';
        resultFeedback.innerHTML = '<div class="alert alert-danger"><strong>‚úó Not quite.</strong> Review the correct answer below.</div>';
        flashcard.classList.add('shake');
        FlashFlow.showToast('Not quite. Keep trying!', 'warning', 2000);
    }

    userAnswerText.textContent = userAnswer;

    setTimeout(() => {
        flashcard.classList.remove('pulse', 'shake');
    }, 500);
}

function compareAnswers(userAnswer, correctAnswer) {
    // Normalize both answers
    const normalize = (str) => str.toLowerCase().trim().replace(/[^\w\s]/g, '');

    const normalizedUser = normalize(userAnswer);
    const normalizedCorrect = normalize(correctAnswer);

    // Exact match
    if (normalizedUser === normalizedCorrect) return true;

    // Check if user answer contains all significant words from correct answer
    const correctWords = normalizedCorrect.split(/\s+/).filter(w => w.length > 2);
    const userWords = normalizedUser.split(/\s+/);

    // If 80% of significant words match, consider it correct
    const matchCount = correctWords.filter(word => userWords.includes(word)).length;
    return matchCount >= correctWords.length * 0.8;
}

function nextCardFromType() {
    submitAnswer(typedAnswerCorrect);
}

// Submit answer to server
async function submitAnswer(correct) {
    flashcard.classList.add(correct ? 'pulse' : 'shake');

    setTimeout(() => {
        flashcard.classList.remove('pulse', 'shake');
    }, 500);

    const loadingOverlay = document.createElement('div');
    loadingOverlay.className = 'loading-overlay';
    loadingOverlay.innerHTML = `
        <div style="text-align: center;">
            <div class="loading-spinner" style="width: 60px; height: 60px; border-width: 4px; margin: 0 auto var(--space-md);"></div>
            <p style="color: var(--color-text-tertiary); font-size: var(--font-size-lg);">Loading next card...</p>
        </div>
    `;

    setTimeout(() => {
        document.body.appendChild(loadingOverlay);
    }, 300);

    try {
        let csrfToken = '{{ csrf_token() }}';

        const response = await fetch('{{ url_for("study.answer", deck_id=deck.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ correct: correct })
        });

        const data = await response.json();

        if (data.success) {
            setTimeout(() => {
                window.location.href = data.next_url;
            }, 500);
        } else {
            throw new Error('Failed to submit answer');
        }
    } catch (error) {
        console.error('Error:', error);
        // Fallback to form submission
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("study.answer", deck_id=deck.id) }}';
        form.innerHTML = `
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="correct" value="${correct}">
        `;
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
